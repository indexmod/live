<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–ö–û–†–û –ë–£–î–£ –ò–ì–†–ê–¢–¨ –Ø</title>
  <meta name="description" content="DJ-—Å–µ—Ç —Å –∞–≤—Ç–æ—Å–≤–µ–¥–µ–Ω–∏–µ–º —Ç—Ä–µ–∫–æ–≤" />
  <meta property="og:title" content="Live DJ Stream" />
  <meta property="og:description" content="DJ-—Å–µ—Ç —Å –∞–≤—Ç–æ—Å–≤–µ–¥–µ–Ω–∏–µ–º —Ç—Ä–µ–∫–æ–≤" />
  <meta property="og:image" content="https://live.indexmod.xyz/favicon/web-app-manifest-512x512.png" />
  <meta property="og:url" content="https://live.indexmod.xyz" />
  <meta property="og:type" content="website" />

  <!-- Favicon links -->
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png" />
  <link rel="manifest" href="favicon/site.webmanifest" />
  <meta name="theme-color" content="#000000" />

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%; background: black; overflow: hidden;
    }
    video {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;
    }
    #overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      cursor: pointer;
    }
    #icon {
      font-size: 10vw;
      color: white;
      user-select: none;
    }
    #text {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
      font-size: 6vw; font-weight: bold; color: white; font-family: Arial, sans-serif; text-align: center;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="overlay">
    <div id="icon">üîä</div>
  </div>

  <div id="text">
    –ó–î–ï–°–¨ –°–ö–û–†–û<br>–ë–£–î–£ –ò–ì–†–ê–¢–¨ –Ø
  </div>

  <video autoplay muted loop playsinline>
    <source src="https://live.indexmod.xyz/dj.mp4" type="video/mp4" />
  </video>

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const fadeDuration = 4;

    async function fetchAudioFilesFromRepo() {
      const response = await fetch('./');
      const text = await response.text();
      const files = [...text.matchAll(/href="([^"]+\.(mp3|wav|ogg|m4a))"/gi)].map(match => match[1]);
      return files;
    }

    async function loadAudio(url) {
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      return await audioContext.decodeAudioData(arrayBuffer);
    }

    async function startCrossfade(files) {
      let index = 0;

      async function playNext() {
        const nextIndex = (index + 1) % files.length;
        const buffer1 = await loadAudio(files[index]);
        const buffer2 = await loadAudio(files[nextIndex]);

        const now = audioContext.currentTime;

        const source1 = audioContext.createBufferSource();
        const gain1 = audioContext.createGain();
        source1.buffer = buffer1;
        source1.connect(gain1).connect(audioContext.destination);
        gain1.gain.setValueAtTime(1, now);
        source1.start(now);

        const source2 = audioContext.createBufferSource();
        const gain2 = audioContext.createGain();
        source2.buffer = buffer2;
        source2.connect(gain2).connect(audioContext.destination);
        gain2.gain.setValueAtTime(0, now);

        const nextStart = now + buffer1.duration - fadeDuration;
        source2.start(nextStart);
        gain1.gain.linearRampToValueAtTime(0, nextStart + fadeDuration);
        gain2.gain.linearRampToValueAtTime(1, nextStart + fadeDuration);

        setTimeout(() => {
          index = nextIndex;
          playNext();
        }, (buffer1.duration - fadeDuration) * 1000);
      }

      playNext();
    }

    document.getElementById('overlay').addEventListener('click', async () => {
      if (audioContext.state === 'suspended') {
        await audioContext.resume();
      }
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('text').style.display = 'flex';

      const audioFiles = await fetchAudioFilesFromRepo();
      if (audioFiles.length > 1) {
        startCrossfade(audioFiles);
      } else if (audioFiles.length === 1) {
        const buffer = await loadAudio(audioFiles[0]);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start();
      }
    }, { once: true });
  </script>
</body>
</html>
